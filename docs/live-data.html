<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ROMY Ring‑Laser Monitor – Live Data Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="style.css" />
  <script src="js/navigation.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <!-- Flatpickr for enabled-date calendar -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .results-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:1rem; }
    .img-wrap { border:1px solid #ddd; padding:.5rem; background:#fafafa; }
    .img-wrap img { max-width:100%; height:auto; display:block; margin:0 auto; }
    code { background:#f3f3f3; padding:2px 4px; border-radius:4px; }
  </style>
  <script defer src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
</head>
<body>
  <section class="hero is-info is-small hero-banner">
    <div class="hero-body">
      <div class="container has-text-centered">
  <h1 class="title is-1 has-text-white"><i class="fas fa-satellite-dish mr-2"></i>Live Data & Archive</h1>
  <p class="subtitle is-4 has-text-white">Recent helicorder & rotation spectra – browse last days, per ring</p>
      </div>
    </div>
  </section>

  <div id="navigation-placeholder"></div>

  <section class="section pt-4">
    <div class="container">
      <div class="box">
  <h2 class="title is-5 mb-2"><i class="fas fa-history mr-2"></i>Archive Browser</h2>
  <div class="level mb-3">
          <div class="level-left">
            <div class="level-item">
              <button id="prevDay" class="button is-small" title="Previous Day">&larr;</button>
            </div>
            <div class="level-item">
              <input type="text" id="datePicker" class="input is-small" placeholder="Select date" />
            </div>
            <div class="level-item">
              <button id="nextDay" class="button is-small" title="Next Day">&rarr;</button>
            </div>
            <div class="level-item">
              <button id="todayBtn" class="button is-small is-link" title="Jump to most recent">Today</button>
            </div>
            <div class="level-item">
              <div class="select is-small">
                <select id="ringFilter">
                  <option value="ALL" selected>All Rings</option>
                  <option value="Z">Ring Z</option>
                  <option value="U">Ring U</option>
                  <option value="V">Ring V</option>
                  <option value="W">Ring W</option>
                </select>
              </div>
            </div>
          </div>
          <div class="level-right">
            <div class="level-item">
              <span id="info" class="is-size-7 has-text-grey"></span>
            </div>
          </div>
        </div>
        <div id="gallery" class="results-grid" style="min-height:240px;"></div>
        <div class="mt-3 is-size-7 has-text-grey" id="meta"></div>
      </div>
      <div class="content">
        <div class="box">
          <h5 class="title is-5"><i class="fas fa-info-circle mr-2"></i>About the Visualizations</h5>
          <div class="content">
            <h6 class="title is-6">Helicorder:</h6>
            <p>The 24-hour helicorder plot shows the processed rotation rate data acquired during the previous day. Each trace is normalized and color-coded by the hour of the day. Any spikes or glitches in the time series are usually linked to mode jumps of the clockwise and counter-clockwise propagating beams. Episodes of high amplitude noise often relate to the absence of the Sagnac interferogram (= no rotation rate data).</p>
            
            <h6 class="title is-6">Rotation Spectra:</h6>
            <p>Each line represents a power spectral density (PSD) of one hour of rotation rate data computed with Welch's method. The colormap is identical with the helicorder plots above.</p>
          </div>
        </div>
        
        <div class="is-size-7 has-text-grey">
          <p><i class="fas fa-info-circle mr-1"></i> Shows archived helicorder & rotation spectra for each ring. Storage window: last ≤ <span id="retWindow">7</span> days. Images older than this are purged automatically by the archive build script.</p>
          <p>Location: <code>docs/figures/live/&lt;DATE&gt;/</code> manifest: <code>docs/figures/live/manifest.json</code></p>
        </div>
      </div>
    </div>
  </section>

  <script>
    const gallery = document.getElementById('gallery');
    const datePicker = document.getElementById('datePicker');
    const prevBtn = document.getElementById('prevDay');
    const nextBtn = document.getElementById('nextDay');
    const todayBtn = document.getElementById('todayBtn');
  const info = document.getElementById('info');
    const meta = document.getElementById('meta');
    const retWindowSpan = document.getElementById('retWindow');
  const ringFilter = document.getElementById('ringFilter');

    let manifest = null;
    let dates = [];
    let currentIndex = 0;
    let fp = null; // flatpickr instance

    function initCalendar(){
      if(typeof flatpickr === 'undefined') return; // CDN failed, keep native behavior
      if(fp) { fp.destroy(); fp = null; }
      fp = flatpickr(datePicker, {
        dateFormat: 'Y-m-d',
        defaultDate: dates[0],
        enable: dates.slice(), // allow only manifest dates
        disableMobile: true,
        // Ensure days from adjacent months that are enabled (in manifest) are visibly enabled
        onDayCreate: function(dObj, dStr, fpInst, dayElem){
          // flatpickr adds classes 'prevMonthDay' or 'nextMonthDay' to overflow days
          if(dayElem.dateObj){
            const y = dayElem.dateObj.getFullYear();
            const m = ('0'+(dayElem.dateObj.getMonth()+1)).slice(-2);
            const dd = ('0'+dayElem.dateObj.getDate()).slice(-2);
            const iso = `${y}-${m}-${dd}`;
            if(dates.indexOf(iso) !== -1){
              // Mark as selectable & remove disabled appearance
              dayElem.classList.remove('flatpickr-disabled');
              dayElem.classList.remove('notAllowed');
              // Remove grayed style of other-month day if it's valid
              dayElem.classList.remove('prevMonthDay','nextMonthDay');
              dayElem.removeAttribute('aria-disabled');
            }
          }
        },
        onChange: function(selectedDates, dateStr){
          const idx = dates.indexOf(dateStr);
          if(idx !== -1){ currentIndex = idx; renderDay(); }
        }
      });
    }

    async function loadManifest(){
      try {
        const r = await fetch('figures/live/manifest.json?v=' + Date.now());
        if(!r.ok) throw new Error('manifest missing');
        manifest = await r.json();
        dates = manifest.dates || [];
        retWindowSpan.textContent = manifest.retention_days || dates.length;
        if(!dates.length){
          gallery.innerHTML = '<div class="notification is-warning is-light">No archive data yet.</div>';
          return;
        }
        // Set to most recent (index 0 because sorted desc in script)
        currentIndex = 0;
        initCalendar();
        setDatePicker(dates[currentIndex]);
        renderDay();
      } catch(e){
        gallery.innerHTML = '<div class="notification is-danger is-light">Failed to load archive manifest.</div>';
      }
    }

    function setDatePicker(d){
      if(fp){ fp.setDate(d, true); }
      else { datePicker.value = d; }
    }
    function getDate() { return datePicker.value; }

    function renderDay(){
      const d = getDate();
      const dayImages = manifest.images[d] || {};
      gallery.innerHTML='';
      const rings = ['Z','U','V','W'];
      rings.forEach(r => {
        if(ringFilter.value !== 'ALL' && ringFilter.value !== r) return;
        const e = dayImages[r];
        if(!e){ return; }
        const wrap = document.createElement('div');
        wrap.className='img-wrap';
        wrap.innerHTML = `<h5 class="title is-6 mb-1">Ring ${r}</h5>`;
        if(e.helicorder){
          wrap.innerHTML += `<figure><img class="lb" loading="lazy" src="${e.helicorder}?v=${Date.now()}" alt="Helicorder R${r}"></figure>`;
        }
        if(e.rotation){
          wrap.innerHTML += `<figure class="mt-2"><img class="lb" loading="lazy" src="${e.rotation}?v=${Date.now()}" alt="Rotation Spectra R${r}"></figure>`;
        }
        gallery.appendChild(wrap);
      });
      info.textContent = d + `  (${currentIndex+1}/${dates.length})`;
      meta.textContent = 'Generated at (manifest): ' + (manifest.generated_at || '');
      updateButtons();
    }

    function updateButtons(){
      prevBtn.disabled = currentIndex >= dates.length - 1;
      nextBtn.disabled = currentIndex <= 0;
    }

    prevBtn.onclick = () => { if(currentIndex < dates.length-1){ currentIndex++; setDatePicker(dates[currentIndex]); renderDay(); } };
    nextBtn.onclick = () => { if(currentIndex > 0){ currentIndex--; setDatePicker(dates[currentIndex]); renderDay(); } };
    todayBtn.onclick = () => { currentIndex = 0; setDatePicker(dates[0]); renderDay(); };
  // Fallback for when flatpickr failed to load
  datePicker.onchange = () => { if(fp) return; const d = getDate(); const idx = dates.indexOf(d); if(idx !== -1){ currentIndex = idx; renderDay(); } };
  ringFilter.onchange = () => renderDay();

    loadManifest();
  </script>
  <!-- ───────── minimal lightbox ───────── -->
  <script>
    (() => {
      const overlay = document.createElement('div');
      overlay.id = 'overlay';
      overlay.innerHTML = '<img>';
      document.body.appendChild(overlay);
      const big = overlay.querySelector('img');

      document.addEventListener('click', e => {
        if (!e.target.classList.contains('lb')) return;
        big.src = e.target.src;
        overlay.classList.add('show');
      });

      overlay.addEventListener('click', () => overlay.classList.remove('show'));
      document.addEventListener('keyup', e => {
        if (e.key === 'Escape') overlay.classList.remove('show');
      });
    })();
  </script>
</body>
</html>
