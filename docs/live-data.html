<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ROMY Ring‑Laser Monitor – Live Data Request</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
  <link rel="stylesheet" href="style.css" />
  <script src="js/navigation.js"></script>
  <style>
    .results-grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:1rem; }
    .img-wrap { border:1px solid #ddd; padding:.5rem; background:#fafafa; }
    .img-wrap img { max-width:100%; height:auto; display:block; margin:0 auto; }
    code { background:#f3f3f3; padding:2px 4px; border-radius:4px; }
  </style>
</head>
<body>
  <section class="hero is-info is-small hero-banner">
    <div class="hero-body">
      <div class="container has-text-centered">
        <h1 class="title is-1 has-text-white">Live Data Request</h1>
        <p class="subtitle is-4 has-text-white">On‑demand helicorder & rotation spectra (does not affect daily pages)</p>
      </div>
    </div>
  </section>

  <div id="navigation-placeholder"></div>

  <section class="section pt-4">
    <div class="container">
      <div class="box">
        <h2 class="title is-4">Recent Live Plots (Coming Soon)</h2>
        <p class="is-size-6 mb-3">This page will soon display the most recent helicorder and rotation spectra images for each ring. You’ll be able to scroll through the last few months of stored plots, updated daily.</p>
        <div class="notification is-info is-light">
          <strong>Note:</strong> This page will show a gallery of the latest available images, updated automatically.
        </div>
        <div class="results-grid" style="min-height:200px;">
          <!-- Gallery of recent images will appear here in the future. -->
        </div>
      </div>
      <div class="content is-size-7 has-text-grey">
        <p>Plots will be stored in <code>figures/live/&lt;DATE&gt;/</code> and shown here for easy browsing.</p>
      </div>
    </div>
  </section>

  <script>
    const form = document.getElementById('requestForm');
    const resultsDiv = document.getElementById('results');
    const msg = document.getElementById('message');
    const prog = document.getElementById('progressBar');
    document.getElementById('clearBtn').onclick = () => { resultsDiv.innerHTML=''; msg.textContent=''; };
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const date = document.getElementById('dateInput').value;
      const rings = [...form.querySelectorAll('input[name="rings"]:checked')].map(c=>c.value);
      if(!date){ alert('Select date'); return; }
      if(!rings.length){ alert('Select at least one ring'); return; }
      prog.style.display='block'; msg.textContent='Requesting generation…'; resultsDiv.innerHTML='';
      try {
        const r = await fetch('/api/live-data', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({date, rings})});
        if(!r.ok){ throw new Error('Request failed '+r.status); }
        const data = await r.json();
        msg.textContent = 'Completed for '+data.date;
        Object.entries(data.results).forEach(([ring, paths])=>{
          if(paths.error){
            const d=document.createElement('div'); d.className='notification is-danger is-light'; d.textContent='R'+ring+': '+paths.error; resultsDiv.appendChild(d); return;
          }
            const wrap=document.createElement('div'); wrap.className='img-wrap';
            wrap.innerHTML = `<h5 class=\"title is-6\">Ring ${ring}</h5>
               <figure><img src=\"${paths.helicorder}?v=${Date.now()}\" alt=\"Helicorder R${ring}\"></figure>
               <figure class=\"mt-2\"><img src=\"${paths.rotation}?v=${Date.now()}\" alt=\"Rotation Spectra R${ring}\"></figure>`;
            resultsDiv.appendChild(wrap);
        });
      } catch(err){
        msg.innerHTML = '<span class="has-text-danger">Error: '+err.message+'</span>';
      } finally {
        prog.style.display='none';
      }
    });
  </script>
</body>
</html>
